# Post-Exploitation Module

The Post-Exploitation Module is a sophisticated component of SentinelProbe that simulates post-exploitation activities after successful vulnerability exploitation. It helps security teams understand the potential impact and reach of security breaches by demonstrating what an attacker could accomplish after gaining initial access.

## Overview

After the Exploitation Engine successfully exploits a vulnerability, the Post-Exploitation Module takes over to simulate further attacker activities. This module operates in a controlled, safe manner to demonstrate potential attack paths without causing actual damage to systems. It provides valuable insights into how attackers might move laterally through a network, escalate privileges, or exfiltrate data.

## Key Features

### Post-Exploitation Techniques

- **Privilege Escalation**: Simulate elevation of privileges on compromised systems
- **Lateral Movement**: Demonstrate how attackers might move between systems
- **Data Exfiltration**: Simulate the extraction of sensitive data
- **Persistence**: Show how attackers might maintain access to compromised systems
- **Defense Evasion**: Demonstrate techniques to avoid detection
- **Credential Access**: Simulate access to stored credentials
- **Discovery**: Show how attackers might gather information about the environment
- **Cleanup**: Safely remove artifacts from simulated post-exploitation activities

### Safety and Control

- **Safe Mode Operation**: Default operation that prevents actual damage
- **Configurable Depth**: Control how far lateral movement extends
- **Technique Selection**: Choose which techniques to use or exclude
- **Timeout Controls**: Set maximum execution time for activities
- **Comprehensive Cleanup**: Automatically remove all artifacts

### Integration

- **Exploitation Engine Integration**: Seamless handoff from exploitation
- **AI Decision Engine Integration**: Intelligent selection of post-exploitation techniques
- **Reporting Integration**: Detailed post-exploitation results for inclusion in reports

## Architecture

The Post-Exploitation Module is built with a modular architecture:

### Core Components

- **Service Layer**: Coordinates post-exploitation activities
- **Techniques**: Specialized implementations for different post-exploitation activities
- **Repository Layer**: Data storage and retrieval for post-exploitation results
- **API Layer**: RESTful API for interacting with the Post-Exploitation Module

### Data Models

The module uses several key data models:

- **PostExploitationActivity**: Base model for all post-exploitation activities
- **PrivilegeEscalationResult**: Results of privilege escalation attempts
- **LateralMovementResult**: Results of lateral movement attempts
- **LateralMovementTarget**: Targets discovered during lateral movement
- **CleanupResult**: Results of cleanup operations
- **PostExploitationConfig**: Configuration for post-exploitation activities

## Post-Exploitation Techniques

### Privilege Escalation

The Privilege Escalation technique simulates how attackers might gain higher-level permissions:

- **Supported Platforms**: Linux, Windows, macOS
- **Techniques**: Kernel exploits, misconfigured services, sudo abuse, etc.
- **Privilege Levels**: User, Admin, System, Root
- **Safety Features**: Simulation mode that doesn't actually change permissions

Example privilege escalation workflow:

1. Identify the current privilege level
2. Discover potential privilege escalation vectors
3. Simulate the exploitation of these vectors
4. Report on the achieved privilege level
5. Document the commands that would be used
6. Perform cleanup if required

### Lateral Movement

The Lateral Movement technique demonstrates how attackers might move between systems:

- **Supported Methods**: SSH, SMB, WinRM, RDP, etc.
- **Target Discovery**: Find potential targets for lateral movement
- **Credential Usage**: Utilize discovered credentials
- **Network Mapping**: Build a map of the network as movement progresses

Example lateral movement workflow:

1. Identify potential targets for movement
2. Determine access methods and required credentials
3. Simulate movement to the target system
4. Discover new potential targets from the new position
5. Report on the expanded attack surface
6. Perform cleanup if required

### Cleanup

The Cleanup technique ensures that all artifacts from post-exploitation activities are removed:

- **Artifact Removal**: Remove files, processes, and other artifacts
- **Log Cleaning**: Simulate the cleaning of logs
- **Trace Removal**: Remove evidence of post-exploitation activities
- **Verification**: Verify that all artifacts have been removed

## Usage Examples

### Programmatic Usage

```python
from sentinelprobe.core.db import get_session
from sentinelprobe.post_exploitation.service import PostExploitationService
from sentinelprobe.post_exploitation.models import (
    PostExploitationType,
    PostExploitationConfig,
    PostExploitationActivityCreate
)

async def perform_post_exploitation(target_id: str, exploit_id: str):
    """Perform post-exploitation activities on a target."""
    async with get_session() as session:
        # Initialize the post-exploitation service
        post_exploit_service = PostExploitationService(session)

        # Configure post-exploitation
        config = PostExploitationConfig(
            max_depth=2,
            safe_mode=True,
            allowed_techniques=["linux_sudo_abuse", "password_file_access"],
            timeout_seconds=300,
            cleanup_required=True
        )

        # Create a privilege escalation activity
        activity_data = PostExploitationActivityCreate(
            type=PostExploitationType.PRIVILEGE_ESCALATION,
            target_id=target_id,
            exploit_id=exploit_id,
            config=config,
            metadata={
                "initial_access_vector": "web_shell",
                "target_os": "linux"
            }
        )

        # Execute the activity
        result = await post_exploit_service.execute_activity(activity_data)

        # Process the result
        if result.success:
            print(f"Privilege escalation successful: {result.details}")
            print(f"Initial privilege: {result.result.initial_privilege}")
            print(f"Achieved privilege: {result.result.achieved_privilege}")
            print(f"Technique used: {result.result.technique_used}")
            print("Commands that would be executed:")
            for cmd in result.result.commands_executed:
                print(f"  {cmd}")
        else:
            print(f"Privilege escalation failed: {result.details}")

        # Perform lateral movement if privilege escalation was successful
        if result.success:
            lateral_activity_data = PostExploitationActivityCreate(
                type=PostExploitationType.LATERAL_MOVEMENT,
                target_id=target_id,
                exploit_id=exploit_id,
                config=config,
                metadata={
                    "source_privilege": str(result.result.achieved_privilege)
                }
            )

            lateral_result = await post_exploit_service.execute_activity(lateral_activity_data)

            if lateral_result.success:
                print(f"Lateral movement successful: {lateral_result.details}")
                print(f"New targets discovered: {len(lateral_result.result.new_targets_discovered)}")
                for target in lateral_result.result.new_targets_discovered:
                    print(f"  {target.hostname} ({target.ip_address}) via {target.access_method}")
            else:
                print(f"Lateral movement failed: {lateral_result.details}")

        # Always perform cleanup
        cleanup_activity_data = PostExploitationActivityCreate(
            type=PostExploitationType.CLEANUP,
            target_id=target_id,
            exploit_id=exploit_id,
            config=config
        )

        cleanup_result = await post_exploit_service.execute_activity(cleanup_activity_data)

        if cleanup_result.success:
            print(f"Cleanup successful: {cleanup_result.details}")
        else:
            print(f"Cleanup failed: {cleanup_result.details}")
```

### API Usage

```python
import aiohttp
import asyncio

async def post_exploitation_via_api():
    """Perform post-exploitation activities via the SentinelProbe API."""
    async with aiohttp.ClientSession() as session:
        # Perform privilege escalation
        privilege_escalation_payload = {
            "activity_type": "privilege_escalation",
            "target_id": "target-123",
            "exploit_id": "exploit-456",
            "config": {
                "max_depth": 2,
                "safe_mode": True,
                "allowed_techniques": ["linux_sudo_abuse", "password_file_access"],
                "timeout_seconds": 300,
                "cleanup_required": True
            },
            "parameters": {
                "target_os": "linux",
                "initial_access_vector": "web_shell"
            }
        }

        response = await session.post(
            "http://localhost:8000/api/post-exploitation/execute",
            json=privilege_escalation_payload
        )

        result = await response.json()

        if result["success"]:
            print(f"Privilege escalation successful: {result['details']}")

            # Perform lateral movement
            lateral_movement_payload = {
                "activity_type": "lateral_movement",
                "target_id": "target-123",
                "exploit_id": "exploit-456",
                "config": {
                    "max_depth": 2,
                    "safe_mode": True,
                    "timeout_seconds": 300,
                    "cleanup_required": True
                },
                "parameters": {
                    "source_privilege": result["result"]["achieved_privilege"]
                }
            }

            lateral_response = await session.post(
                "http://localhost:8000/api/post-exploitation/execute",
                json=lateral_movement_payload
            )

            lateral_result = await lateral_response.json()

            if lateral_result["success"]:
                print(f"Lateral movement successful: {lateral_result['details']}")
                print(f"New targets discovered: {len(lateral_result['result']['new_targets_discovered'])}")
            else:
                print(f"Lateral movement failed: {lateral_result['details']}")
        else:
            print(f"Privilege escalation failed: {result['details']}")

        # Always perform cleanup
        cleanup_payload = {
            "activity_type": "cleanup",
            "target_id": "target-123",
            "exploit_id": "exploit-456",
            "config": {
                "safe_mode": True,
                "timeout_seconds": 300
            }
        }

        cleanup_response = await session.post(
            "http://localhost:8000/api/post-exploitation/execute",
            json=cleanup_payload
        )

        cleanup_result = await cleanup_response.json()

        if cleanup_result["success"]:
            print(f"Cleanup successful: {cleanup_result['details']}")
        else:
            print(f"Cleanup failed: {cleanup_result['details']}")

# Run the async function
loop = asyncio.get_event_loop()
loop.run_until_complete(post_exploitation_via_api())
```

### Command Line Usage

```bash
# Perform privilege escalation
python -m sentinelprobe post-exploitation execute \
    --type privilege_escalation \
    --target-id target-123 \
    --exploit-id exploit-456 \
    --safe-mode \
    --max-depth 2 \
    --timeout 300 \
    --parameters '{"target_os": "linux", "initial_access_vector": "web_shell"}'

# Perform lateral movement
python -m sentinelprobe post-exploitation execute \
    --type lateral_movement \
    --target-id target-123 \
    --exploit-id exploit-456 \
    --safe-mode \
    --max-depth 2 \
    --timeout 300 \
    --parameters '{"source_privilege": "root"}'

# Perform cleanup
python -m sentinelprobe post-exploitation execute \
    --type cleanup \
    --target-id target-123 \
    --exploit-id exploit-456 \
    --safe-mode \
    --timeout 300
```

## Integration with AI Decision Engine

The Post-Exploitation Module integrates with the AI Decision Engine in several ways:

1. **Technique Selection**: The AI Decision Engine helps select the most appropriate post-exploitation techniques based on the target environment
2. **Path Optimization**: Determines the most efficient path for lateral movement
3. **Risk Assessment**: Evaluates the risk of different post-exploitation activities
4. **Impact Analysis**: Assesses the potential impact of successful post-exploitation

## Privilege Escalation Techniques

The module supports various privilege escalation techniques:

### Linux Privilege Escalation

- **SUID Binaries**: Identify and exploit SUID binaries
- **Sudo Misconfigurations**: Exploit sudo configuration issues
- **Kernel Exploits**: Simulate kernel vulnerability exploitation
- **Cron Jobs**: Identify and exploit writable cron jobs
- **World-Writable Files**: Exploit world-writable files in sensitive locations

### Windows Privilege Escalation

- **Service Misconfigurations**: Exploit insecure service configurations
- **Unquoted Service Paths**: Identify and exploit unquoted service paths
- **DLL Hijacking**: Simulate DLL hijacking attacks
- **Registry Vulnerabilities**: Exploit registry-based vulnerabilities
- **Token Manipulation**: Simulate token manipulation techniques

## Lateral Movement Techniques

The module supports various lateral movement techniques:

### Network-Based Movement

- **SSH**: Simulate movement via SSH
- **SMB**: Simulate movement via SMB/CIFS
- **WinRM**: Simulate movement via Windows Remote Management
- **RDP**: Simulate movement via Remote Desktop Protocol

### Credential-Based Movement

- **Password Reuse**: Simulate movement using discovered passwords
- **Pass-the-Hash**: Simulate movement using password hashes
- **Kerberos Tickets**: Simulate movement using Kerberos tickets
- **API Tokens**: Simulate movement using discovered API tokens

## Security and Ethical Considerations

When using the Post-Exploitation Module:

- **Authorization**: Always obtain proper authorization before testing
- **Safe Mode**: Always use safe mode in production environments
- **Data Handling**: Handle any discovered data with care
- **Scope Limitation**: Clearly define and respect the scope of testing
- **Legal Compliance**: Ensure all activities comply with relevant laws and regulations

## Performance Considerations

To optimize the performance of the Post-Exploitation Module:

- **Depth Limitation**: Limit the depth of lateral movement
- **Technique Selection**: Focus on relevant techniques for the target environment
- **Timeout Management**: Set appropriate timeouts for activities
- **Resource Allocation**: Allocate sufficient resources for post-exploitation activities

## Troubleshooting

### Common Issues

1. **Activity Timeouts**:
   - Increase the timeout value
   - Reduce the depth of lateral movement
   - Limit the number of techniques used

2. **Failed Activities**:
   - Check if the target is still accessible
   - Verify that the exploit was successful
   - Check if the required privileges are available
   - Review the technique compatibility with the target

3. **Cleanup Failures**:
   - Manually verify the cleanup status
   - Check if the target is still accessible
   - Review the cleanup logs for specific errors

## API Reference

For a complete API reference, see the [API Documentation](../advanced/api-reference.md#post-exploitation-module).
