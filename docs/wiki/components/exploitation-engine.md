# Exploitation Engine

The Exploitation Engine is a core component of SentinelProbe that provides controlled, simulated exploitation of discovered vulnerabilities to validate their existence and assess their impact. It serves as a bridge between vulnerability discovery and post-exploitation activities.

## Overview

The Exploitation Engine takes vulnerabilities identified by the Vulnerability Scanner and attempts to exploit them in a controlled, safe manner. This validation step helps eliminate false positives and provides concrete evidence of security issues, allowing security teams to prioritize remediation efforts based on actual exploitability rather than theoretical risk.

## Key Features

### Exploitation Capabilities

- **Multiple Exploit Types**: Support for various exploitation techniques including SQL injection, command injection, XSS, XXE, CSRF, and more
- **Safe Simulation Mode**: Perform simulated exploits without causing harm to target systems
- **Payload Generation**: Dynamically generate payloads tailored to specific vulnerabilities
- **Success Verification**: Automatically verify if exploitation attempts were successful

### Risk Management

- **Risk Assessment**: Calculate risk levels for each exploit based on multiple factors
- **Safe Mode Operation**: Default operation mode that prevents actual damage
- **Detailed Logging**: Comprehensive logging of all exploitation activities
- **Exploitation Controls**: Fine-grained control over exploitation parameters

### Integration

- **Vulnerability Scanner Integration**: Seamless integration with the Vulnerability Scanner module
- **AI Decision Engine Integration**: Intelligent selection of exploitation techniques
- **Post-Exploitation Handoff**: Smooth transition to post-exploitation activities
- **Reporting Integration**: Detailed exploitation results for inclusion in reports

## Architecture

The Exploitation Engine is built on a modular, plugin-based architecture:

### Core Components

- **Exploitation Service**: Central service that coordinates exploitation activities
- **Plugin System**: Extensible framework for adding new exploitation techniques
- **Repository Layer**: Data storage and retrieval for exploits and attempt records
- **API Layer**: RESTful API for interacting with the Exploitation Engine

### Data Models

The Exploitation Engine uses several key data models:

- **Exploit**: Represents a potential exploit for vulnerabilities
- **ExploitAttempt**: Records an attempt to exploit a vulnerability
- **ExploitResult**: Contains the results of an exploitation attempt
- **ExploitConfig**: Configuration for exploitation attempts

### Plugin System

The plugin system is based on the `ExploitPlugin` abstract base class, which defines:

- **Metadata Properties**: Name, description, exploit type, payload type, etc.
- **Applicability Check**: Determines if a plugin can exploit a specific vulnerability
- **Payload Generation**: Creates payloads tailored to vulnerabilities
- **Execution Logic**: Handles the actual exploitation process
- **Success Verification**: Determines if an exploitation attempt was successful

## Available Plugins

The Exploitation Engine includes several built-in plugins:

### SQL Injection Plugin

The SQL Injection plugin targets database vulnerabilities:

- **Supported Databases**: MySQL, PostgreSQL, SQLite, Oracle, SQL Server
- **Injection Techniques**: Union-based, error-based, boolean-based, time-based
- **Capabilities**: Data extraction, schema enumeration, privilege escalation
- **Safety Features**: Query limiting, read-only operations in safe mode

### Command Injection Plugin

The Command Injection plugin targets OS command execution vulnerabilities:

- **Supported Systems**: Linux, Windows, macOS
- **Injection Techniques**: Direct command execution, command chaining, encoding bypass
- **Capabilities**: System information gathering, file access, network reconnaissance
- **Safety Features**: Limited command set in safe mode, output validation

## Exploitation Process

The exploitation process follows these steps:

1. **Vulnerability Selection**: Choose a vulnerability to exploit
2. **Plugin Selection**: Identify applicable exploitation plugins
3. **Configuration**: Set exploitation parameters and safety controls
4. **Payload Generation**: Generate a tailored exploitation payload
5. **Execution**: Attempt to exploit the vulnerability
6. **Verification**: Determine if the exploitation was successful
7. **Result Processing**: Record and analyze the exploitation results

## Usage Examples

### Programmatic Usage

```python
from sentinelprobe.core.db import get_session
from sentinelprobe.exploitation.repository import ExploitRepository
from sentinelprobe.exploitation.service import ExploitationService
from sentinelprobe.exploitation.models import ExploitConfig

async def exploit_vulnerability(vulnerability_id: int, target_id: int):
    """Attempt to exploit a vulnerability."""
    async with get_session() as session:
        # Initialize repositories and services
        exploit_repo = ExploitRepository(session)
        exploitation_service = ExploitationService(
            exploit_repository=exploit_repo,
            session=session
        )

        # Find applicable exploits
        applicable_exploits = await exploitation_service.get_applicable_exploits(
            vulnerability_id=vulnerability_id,
            target_id=target_id
        )

        if not applicable_exploits:
            print("No applicable exploits found")
            return

        # Select the first applicable exploit
        exploit = applicable_exploits[0]

        # Configure the exploitation attempt
        config = ExploitConfig(
            safe_mode=True,
            timeout=30,
            max_attempts=3,
            parameters={
                "payload_type": "information_gathering",
                "custom_parameter": "value"
            }
        )

        # Execute the exploit
        result = await exploitation_service.execute_exploit(
            exploit_id=exploit.id,
            vulnerability_id=vulnerability_id,
            target_id=target_id,
            config=config
        )

        # Process the result
        if result.success:
            print(f"Exploitation successful: {result.message}")
            print(f"Output: {result.raw_output}")
            if result.extracted_data:
                print("Extracted data:")
                for key, value in result.extracted_data.items():
                    print(f"  {key}: {value}")
        else:
            print(f"Exploitation failed: {result.message}")
```

### API Usage

```python
import aiohttp
import asyncio

async def exploit_via_api():
    """Exploit a vulnerability via the SentinelProbe API."""
    async with aiohttp.ClientSession() as session:
        # Find applicable exploits
        vulnerability_id = 123
        response = await session.get(
            f"http://localhost:8000/api/exploitation/plugins/by-vulnerability/{vulnerability_id}"
        )
        applicable_plugins = await response.json()

        if not applicable_plugins:
            print("No applicable exploits found")
            return

        # Select the first applicable plugin
        plugin_name = applicable_plugins[0]["name"]

        # Execute the exploit
        payload = {
            "plugin_name": plugin_name,
            "vulnerability_id": vulnerability_id,
            "target_id": 456,
            "config": {
                "safe_mode": True,
                "timeout": 30,
                "max_attempts": 3,
                "parameters": {
                    "payload_type": "information_gathering"
                }
            }
        }

        response = await session.post(
            "http://localhost:8000/api/exploitation/execute",
            json=payload
        )
        result = await response.json()

        # Process the result
        if result["success"]:
            print(f"Exploitation successful: {result['message']}")
            print(f"Output: {result['raw_output']}")
            if "extracted_data" in result and result["extracted_data"]:
                print("Extracted data:")
                for key, value in result["extracted_data"].items():
                    print(f"  {key}: {value}")
        else:
            print(f"Exploitation failed: {result['message']}")

# Run the async function
loop = asyncio.get_event_loop()
loop.run_until_complete(exploit_via_api())
```

### Command Line Usage

```bash
# List available exploitation plugins
python -m sentinelprobe exploitation plugins list

# Get information about a specific plugin
python -m sentinelprobe exploitation plugins info sql_injection

# Find applicable plugins for a vulnerability
python -m sentinelprobe exploitation plugins applicable --vulnerability-id 123

# Generate an exploitation payload
python -m sentinelprobe exploitation payload generate \
    --plugin sql_injection \
    --vulnerability-id 123 \
    --target-id 456 \
    --parameters '{"payload_type": "information_gathering"}'

# Execute an exploit
python -m sentinelprobe exploitation execute \
    --plugin sql_injection \
    --vulnerability-id 123 \
    --target-id 456 \
    --safe-mode \
    --parameters '{"payload_type": "information_gathering"}'
```

## Integration with AI Decision Engine

The Exploitation Engine integrates with the AI Decision Engine in several ways:

1. **Exploit Selection**: The AI Decision Engine helps select the most appropriate exploitation techniques based on vulnerability characteristics
2. **Parameter Optimization**: Exploitation parameters are optimized based on target characteristics and vulnerability details
3. **Success Prediction**: The AI can predict the likelihood of successful exploitation
4. **Risk Assessment**: The AI helps assess the risk level of different exploitation approaches

## Extending the Engine

The plugin-based architecture makes it easy to extend the Exploitation Engine with new exploitation techniques:

1. **Create a New Plugin**: Create a new class that extends `ExploitPlugin`
2. **Implement Required Methods**: Implement all abstract methods and properties
3. **Register the Plugin**: Place the plugin in the `plugins` directory

Example of a custom plugin:

```python
from typing import Any, Dict, List, Tuple

from sentinelprobe.exploitation.models import ExploitType, PayloadType
from sentinelprobe.exploitation.plugin import ExploitPlugin
from sentinelprobe.reconnaissance.models import Target
from sentinelprobe.vulnerability_scanner.models import Vulnerability

class CustomExploitPlugin(ExploitPlugin):
    """Custom exploitation plugin."""

    @property
    def name(self) -> str:
        return "custom_exploit"

    @property
    def description(self) -> str:
        return "Custom exploitation plugin for specific vulnerabilities"

    @property
    def exploit_type(self) -> ExploitType:
        return ExploitType.OTHER

    @property
    def payload_type(self) -> PayloadType:
        return PayloadType.OTHER

    @property
    def target_services(self) -> List[str]:
        return ["custom_service"]

    @property
    def risk_level(self) -> int:
        return 5  # Medium risk

    async def check_applicability(
        self, vulnerability: Vulnerability, target: Target
    ) -> bool:
        # Check if this plugin can exploit the vulnerability
        return (
            vulnerability.affected_component == "custom_component" and
            "custom_service" in target.services
        )

    async def generate_payload(
        self, vulnerability: Vulnerability, target: Target, parameters: Dict[str, Any]
    ) -> str:
        # Generate a payload for the vulnerability
        payload_type = parameters.get("payload_type", "default")

        if payload_type == "information_gathering":
            return "CUSTOM_PAYLOAD_INFO"
        else:
            return "CUSTOM_PAYLOAD_DEFAULT"

    async def execute_exploit(
        self,
        vulnerability: Vulnerability,
        target: Target,
        payload: str,
        safe_mode: bool = True,
    ) -> Tuple[str, bool]:
        # Execute the exploit
        if safe_mode:
            # Simulate the exploitation
            result = f"Simulated exploitation with payload: {payload}"
            success = True
        else:
            # Perform actual exploitation
            # ... implementation details ...
            result = "Exploitation result"
            success = True

        return result, success

    async def check_success(
        self, vulnerability: Vulnerability, target: Target, result: str
    ) -> bool:
        # Check if the exploitation was successful
        return "success indicator" in result.lower()
```

## Security and Ethical Considerations

When using the Exploitation Engine:

- **Authorization**: Always obtain proper authorization before testing vulnerabilities
- **Safe Mode**: Use safe mode whenever possible to prevent unintended damage
- **Scope Limitation**: Clearly define and respect the scope of testing
- **Data Handling**: Handle any data obtained through exploitation with care
- **Legal Compliance**: Ensure all activities comply with relevant laws and regulations

## Performance Considerations

To optimize the performance of the Exploitation Engine:

- **Targeted Exploitation**: Focus on high-value vulnerabilities rather than attempting to exploit everything
- **Timeout Management**: Set appropriate timeouts for exploitation attempts
- **Concurrency Control**: Limit the number of concurrent exploitation attempts
- **Resource Allocation**: Allocate sufficient resources for exploitation activities

## Troubleshooting

### Common Issues

1. **Exploitation Failures**:
   - Check network connectivity to the target
   - Verify that the vulnerability still exists
   - Ensure the exploitation parameters are correct
   - Try different exploitation techniques

2. **Performance Issues**:
   - Reduce the number of concurrent exploitation attempts
   - Increase timeouts for slow targets
   - Optimize exploitation parameters

3. **Plugin Issues**:
   - Verify that the plugin is compatible with the vulnerability
   - Check for plugin updates
   - Review plugin configuration

## API Reference

For a complete API reference, see the [API Documentation](../advanced/api-reference.md#exploitation-engine).
